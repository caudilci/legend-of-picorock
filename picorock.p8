pico-8 cartridge // http://www.pico-8.com
version 41
__lua__

px,py,pa = 4.5,4.5,0
x,y,vx,vy,ox,oy,dx,dy,ix,iy,d=0
sens = 0.01
speed = 0.05
h=40
cs = {13,8,12}

function _init()

end

function _update()
    // player control
	if btn(0) then
		pa+=sens
        if pa>1 then
			pa-=1
		end
	end
	if btn(1) then
		pa-=sens
        if pa<0 then
			pa+=1
		end
	end
	if btn(2) then
		px+=cos(pa)*speed
		py+=sin(pa)*speed
	end
	if btn(3) then
		px-=cos(pa)*speed
		py-=sin(pa)*speed
	end
end

function _draw()
    cls(5)
    rectfill(0,64,128,128,6)
    fov()
    print(px,2,2,10)
    print(py,2,10,10)
    

end

function fov()
    for i=0,127 do
        
        -- starting tile
        x=px
        y=py

        -- ray direction fov90 centered on pa
        vx=cos(pa-(i-64)/512)
        vy=sin(pa-(i-64)/512)
        
        -- standard distance
        dx=abs(1/vx)
        dy=abs(1/vy)

        -- increment values
        ix=vx>0 and 1 or -1
        iy=vy>0 and 1 or -1

        -- find initial offset
        if vx>0 then
            ox=(flr(x)-x+1)/vx
        else
            ox=abs((x-flr(x))/vx)
        end
        if vy>0 then
            oy=(flr(y)-y+1)/vy
        else
            oy=abs((y-flr(y))/vy)
        end

        while true do
            -- horizontal intersection
            if ox<oy then
                x+=ix
                d=ox
                ox+=dx
            else --vertical intersection
                y+=iy
                d=oy
                oy+=dy
            end
            -- check colision 
            if mget(x,y)>0 or x<0 or y<0  then
                line(i,64-h/d, i, 64+h/d, cs[mget(x,y)])
                break
            end
        end
    end

end
__gfx__
00000000dddddddd88888888cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000dddddddd88888888cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700dddddddd88888888cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000dddddddd88888888cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000dddddddd88888888cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700dddddddd88888888cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000dddddddd88888888cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000dddddddd88888888cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000100000001000000030000000300000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000300000003000000010000000100000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
